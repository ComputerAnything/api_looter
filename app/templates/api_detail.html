{% extends "layout.html" %}
{% block title %}API Looter - {{ api.name }}{% endblock %}
{% block content %}

<!-- Adult Content Warning Modal -->
{% if api.get('is_adult') %}
<div id="adultWarningModal" class="modal">
    <div class="modal-content">
        <h2>‚ö†Ô∏è Content Warning</h2>
        <p>{{ api.get('adult_warning', 'This API may contain content not suitable for all audiences.') }}</p>
        <div class="modal-buttons">
            <button class="modal-btn modal-btn-confirm" onclick="confirmAndClose()">I Understand, Continue</button>
            <a href="{{ url_for('main.index') }}" class="modal-btn modal-btn-back">Go Back</a>
        </div>
    </div>
</div>
{% endif %}

<div class="api-detail-center">
    <h2>{{ api.name }}</h2>
    <p>{{ api.description }}</p>
    <p><strong>Endpoint:</strong> {{ api.endpoint }}</p>

    <!-- Educational Content -->
    {% if api.why_use or api.how_use %}
    <div class="api-education">
        {% if api.why_use %}
        <h3>üí° Why Use This API?</h3>
        <p>{{ api.why_use }}</p>
        {% endif %}

        {% if api.how_use %}
        <h3>üîß How Developers Use It</h3>
        <p>{{ api.how_use }}</p>
        {% endif %}

        {% if api.category %}
        <p style="margin-top: 1rem; font-size: 0.9em; color: #1abc9c;">
            <strong>Category:</strong> {{ api.category }}
        </p>
        {% endif %}
    </div>
    {% endif %}

    <form method="post" class="api-form">
        {% if api.parameters and api.parameters|length > 0 %}
            <fieldset style="border:1px solid #ccc; padding:1em; margin-bottom:1em;">
                <legend><strong>Enter Required Parameters</strong></legend>
                {% for param in api.parameters %}
                    <div style="margin-bottom:0.75em;">
                        <label for="{{ param.name }}">
                            {{ param.label }}{% if param.required %} <span style="color:red">*</span>{% endif %}
                        </label><br>
                        {% if param.type == "select" and param.options %}
                            <select name="{{ param.name }}" id="{{ param.name }}" style="width: 100%; max-width: 350px; padding: 0.5em;" {% if param.required %}required{% endif %}>
                                <option value="">-- Select --</option>
                                {% for option in param.options %}
                                    <option value="{{ option.value }}">{{ option.label }}</option>
                                {% endfor %}
                            </select>
                        {% else %}
                            <input
                                type="{{ param.type }}"
                                name="{{ param.name }}"
                                id="{{ param.name }}"
                                placeholder="Enter {{ param.label|lower }}"
                                {% if param.required %}required{% endif %}
                                style="width: 100%; max-width: 350px; padding: 0.5em;"
                            >
                        {% endif %}
                    </div>
                {% endfor %}
                </fieldset>
        {% else %}
            <p style="color: #888;">No parameters required for this API.</p>
        {% endif %}
        <div class="center-btn">
            <button type="submit" style="padding:0.5em 1.5em;">Call API</button>
        </div>
    </form>
    <a href="{{ url_for('main.index') }}" class="back-btn">‚Üê Back to List</a>

    <h3>Result:</h3>
    {% if result %}
        {% if result_type == "json" %}
            <pre style="background:#222; color:#fff; padding:1em; border-radius:6px; max-height:300px; overflow:auto;">
                <code class="language-json">{{ result | safe }}</code>
            </pre>
        {% elif result_type == "image" %}
            <img src="{{ result }}" alt="API Image Result" style="max-width:100%; border:1px solid #ccc; border-radius:6px;">
        {% else %}
            <div style="background:#222; color:#fff; padding:1em; border-radius:6px; max-height:300px; overflow:auto;">
                {{ result|safe }}
            </div>
        {% endif %}
    {% else %}
        <p style="color: #888;">No result to display. Submit the form to call the API.</p>
    {% endif %}
</div>

<script>
    // Handle adult content warning modal
    {% if api.get('is_adult') %}
    window.addEventListener('load', function() {
        const modal = document.getElementById('adultWarningModal');
        modal.style.display = 'block';
    });

    function confirmAndClose() {
        document.getElementById('adultWarningModal').style.display = 'none';
    }
    {% endif %}

    // Add a loading spinner when the form is submitted
    const form = document.querySelector('.api-form');
    const loading = document.createElement('div');
    loading.innerHTML = '<p>Loading...</p>';
    loading.style.textAlign = 'center';
    loading.style.marginTop = '1em';
    loading.style.display = 'none';
    form.parentNode.insertBefore(loading, form.nextSibling);

    form.addEventListener('submit', () => {
        loading.style.display = 'block';
    });
</script>
{% endblock %}
